---
import Layout from '../layouts/Layout.astro';
import { socials } from '../config/socials';
import SocialIcons from '../components/SocialIcons.astro';
import { Picture } from 'astro:assets';
import avatar from '../images/avatar.jpg';
---

<Layout title="Soumyo Dey">
  <div class="absolute top-0 left-1/2 -z-10 h-[500px] w-[500px] -translate-x-1/2 rounded-full bg-violet-500/20 blur-[100px] dark:bg-violet-900/20"></div>
  
  <main class="flex min-h-[calc(100vh-4rem)] flex-col items-center justify-center py-12">
    <div class="text-center">
      <div class="animate-fade-in relative mx-auto mb-8 h-32 w-32">
        <div class="absolute inset-0 rounded-full bg-gradient-to-r from-violet-500 to-fuchsia-500 blur-lg opacity-75"></div>
        <div class="absolute inset-0 rounded-full bg-gradient-to-r from-violet-500 to-fuchsia-500"></div>
        <Picture
          src={avatar}
          widths={[128, 256]}
          sizes="128px"
          formats={['avif', 'webp', 'jpeg']}
          alt="Profile"
          loading="eager"
          fetchpriority="high"
          class="relative h-full w-full rounded-full object-cover"
        />
      </div>

      <h1 class="animate-fade-in delay-100 mb-4 text-4xl font-bold font-serif tracking-tight text-slate-900 dark:text-white">Soumyo Dey</h1>
      <p class="animate-fade-in delay-200 mb-8 text-lg text-slate-600 dark:text-slate-400">
        A Man who travels the world eating noodles
      </p>

      <div class="animate-fade-in delay-300 mb-12 flex justify-center gap-4">
        {socials.map((social) => <SocialIcons {...social} />)}
      </div>

      <!-- Newsletter section with optimized loading -->
      <div
        id="newsletter-section"
        class="animate-fade-in delay-300 glass-panel mx-auto w-full max-w-2xl overflow-hidden rounded-xl border border-gray-200 bg-white/50 dark:border-white/5 dark:bg-white/5"
      >
        <!-- Static content shown immediately -->
        <div class="p-8 text-center">
          <h2 class="mb-3 text-2xl font-bold font-serif text-slate-900 dark:text-white">Subscribe to Stochastic Musings!</h2>
          <p class="mb-6 text-slate-600 dark:text-slate-300">
            Get my writings directly in your inbox.
          </p>
          <button
            id="load-newsletter"
            class="rounded-lg bg-gradient-to-r from-violet-600 to-fuchsia-600 px-6 py-2.5 font-medium text-white shadow-lg shadow-violet-500/25 transition-all hover:scale-105 hover:shadow-violet-500/40 active:scale-95"
            onclick="loadNewsletterEmbed()"
          >
            Subscribe Here!
          </button>
        </div>

        <!-- Container for lazy-loaded iframe -->
        <div id="substack-container" class="hidden">
          <div
            class="flex h-[320px] w-full items-center justify-center text-gray-500 dark:text-gray-400"
          >
            Loading newsletter...
          </div>
        </div>
      </div>
    </div>
    <script is:inline>
      function setupNewsletter() {
        function loadNewsletterEmbed() {
          const container = document.getElementById('substack-container');
          const button = document.getElementById('load-newsletter');

          if (container && button) {
            // Show container
            container.classList.remove('hidden');

            // Create and append iframe
            const iframe = document.createElement('iframe');
            iframe.src = 'https://stochasticmusings.substack.com/embed';
            iframe.style.width = '100%';
            iframe.style.height = '320px';
            iframe.style.border = 'none';
            iframe.classList.add('rounded-lg', 'dark:filter', 'dark:invert');

            // Replace loading message with iframe
            container.innerHTML = '';
            container.appendChild(iframe);

            // Hide button
            button.parentElement.classList.add('hidden');
          }
        }
        
        // Expose to global scope for onclick handler
        window.loadNewsletterEmbed = loadNewsletterEmbed;

        // Load newsletter automatically if user has previously interacted
        if (localStorage.getItem('newsletter-interaction')) {
          setTimeout(loadNewsletterEmbed, 1000);
        }

        // Save interaction preference
        document.getElementById('load-newsletter')?.addEventListener('click', () => {
          localStorage.setItem('newsletter-interaction', 'true');
        });
      }
      
      // Initial load
      setupNewsletter();
      
      // View Transitions load
      document.addEventListener('astro:page-load', setupNewsletter);
    </script>
  </main>
</Layout>

<style>
  iframe {
    min-width: 480px;
    max-width: 100%;
    width: 100%;
    height: 320px;
    background: transparent;
  }

  @media (max-width: 480px) {
    iframe {
      min-width: 100%;
    }
  }
</style>
