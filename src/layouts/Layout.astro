---
import ScriptOptimizer from '../components/ScriptOptimizer.astro';
import PostHog from '../components/posthog.astro';
import { ClientRouter } from 'astro:transitions';
import '@fontsource/playfair-display';
import '@fontsource/playfair-display/400-italic.css';
import '@fontsource/roboto-slab';
import '@fontsource/plus-jakarta-sans';
import '../styles/globals.css';

interface Props {
  title: string;
  analytics?: boolean;
  substack?: boolean;
  socialEmbed?: boolean;
}

const {
  title,
  analytics = false, // Disabled by default since not using Plausible
  substack = false, // Enable only on pages that need it
  socialEmbed = false, // Enable only on pages that need it
} = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <!-- Theme boot is inlined above; external preload removed -->
    <meta charset="UTF-8" />
    <meta name="description" content="Tech, AI & data products, and the stories picked up along the way" />
    <meta name="viewport" content="width=device-width" />
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)" />
    <meta name="theme-color" content="#1a1a1a" media="(prefers-color-scheme: dark)" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

    
    
    <script is:inline>
      function getTheme() {
        if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
          return localStorage.getItem('theme');
        }
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
          return 'dark';
        }
        return 'light';
      }

      function applyTheme() {
        const theme = getTheme();
        if (theme === 'dark') {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      }

      applyTheme();
      document.addEventListener('astro:after-swap', applyTheme);
    </script>

    <!-- Font optimization removed (using globals.css) -->

    <!-- Inline critical CSS -->
    <style is:inline>
      /* Add only the most critical styles here */
      :root {
        color-scheme: light dark;
        font-family: var(--font-sans);
      }
      body {
        margin: 0;
        text-rendering: optimizeLegibility;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      img {
        max-width: 100%;
        height: auto;
      }
    </style>

    <!-- Theme boot is inlined above; external preload removed -->

    <!-- Cache control -->
    <!-- Cache is controlled via HTTP headers; meta tag removed -->

    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>

    <!-- Only preload profile images on homepage -->
    {
      Astro.url.pathname === '/' && (
        <>
          <link
            rel="preload"
            fetchpriority="high"
            as="image"
            type="image/webp"
            href="/images/profile-128.webp"
            imagesrcset="/images/profile-128.webp 1x, /images/profile-256.webp 2x"
            imagesizes="128px"
          />
        </>
      )
    }

    <!-- Optimize third-party scripts -->
    <ScriptOptimizer analytics={analytics} substack={substack} socialEmbed={socialEmbed} />
    <PostHog />
    <ClientRouter />
  </head>
  <body class="min-h-screen bg-[var(--color-bg-light)] font-sans text-[var(--color-text-light)] antialiased transition-colors duration-300 dark:bg-[var(--color-bg-dark)] dark:text-[var(--color-text-dark)]">
    <!-- Noise Texture Overlay -->
    <div class="pointer-events-none fixed inset-0 z-[100] opacity-[0.03] mix-blend-overlay" style="background-image: url('data:image/svg+xml,%3Csvg viewBox=%220 0 200 200%22 xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cfilter id=%22noiseFilter%22%3E%3CfeTurbulence type=%22fractalNoise%22 baseFrequency=%220.65%22 numOctaves=%223%22 stitchTiles=%22stitch%22/%3E%3C/filter%3E%3Crect width=%22100%25%22 height=%22100%25%22 filter=%22url(%23noiseFilter)%22/%3E%3C/svg%3E');"></div>
    <nav
      class="fixed left-0 right-0 top-0 z-50 border-b border-transparent bg-[rgba(245,247,251,0.9)] shadow-[0_6px_25px_rgba(15,23,42,0.08)] backdrop-blur-xl transition-colors duration-300 dark:border-[rgba(255,255,255,0.08)] dark:bg-[rgba(15,23,42,0.85)]"
    >
      <div class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8">
        <div class="flex h-16 items-center justify-between">
          <a href="/" class="text-lg font-semibold tracking-tight text-[var(--color-text-light)] transition-colors hover:text-[var(--color-primary-light)] dark:text-[var(--color-text-dark)] dark:hover:text-[var(--color-primary-dark)]"
            >Soumyo Dey</a
          >

          <div class="hidden items-center gap-8 text-sm font-medium uppercase tracking-[0.2em] text-[var(--color-muted-light)] md:flex">
            <a href="/blog" class="transition-colors hover:text-[var(--color-primary-light)] dark:text-[var(--color-muted-dark)] dark:hover:text-[var(--color-primary-dark)]" data-astro-prefetch
              >Blog</a
            >

            <a href="/about" class="transition-colors hover:text-[var(--color-primary-light)] dark:text-[var(--color-muted-dark)] dark:hover:text-[var(--color-primary-dark)]" data-astro-prefetch
              >About</a
            >

          </div>

          <div class="flex items-center gap-4">
            <button
              id="theme-toggle"
              aria-label="Toggle dark mode"
              class="rounded-full border border-[var(--color-border-light)]/70 p-2 text-[var(--color-muted-light)] transition-colors hover:border-transparent hover:bg-[var(--color-primary-light)]/10 hover:text-[var(--color-primary-light)] focus:outline-none dark:border-[var(--color-border-dark)] dark:text-[var(--color-muted-dark)] dark:hover:bg-[var(--color-primary-dark)]/15 dark:hover:text-[var(--color-primary-dark)]"
            >
              <svg
                id="theme-toggle-dark-icon"
                class="block h-5 w-5 dark:hidden"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
                ></path>
              </svg>
              <svg
                id="theme-toggle-light-icon"
                class="hidden h-5 w-5 dark:block"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
                ></path>
              </svg>
            </button>
            <button id="menu-toggle" aria-label="Toggle navigation menu" class="rounded-full border border-[var(--color-border-light)]/70 p-2 text-[var(--color-text-light)] transition-colors hover:border-transparent hover:bg-[var(--color-primary-light)]/10 hover:text-[var(--color-primary-light)] focus:outline-none md:hidden dark:border-[var(--color-border-dark)] dark:text-[var(--color-text-dark)] dark:hover:bg-[var(--color-primary-dark)]/15 dark:hover:text-[var(--color-primary-dark)]">
              <svg
                class="h-6 w-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 12h16M4 18h16"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <div
        id="mobile-menu"
        class="hidden border-t border-[var(--color-border-light)] bg-[var(--color-surface-light)]/95 text-[var(--color-muted-light)] shadow-card dark:border-[var(--color-border-dark)] dark:bg-[var(--color-surface-dark)] dark:text-[var(--color-muted-dark)] md:hidden"
      >
        <div class="flex flex-col space-y-4 px-4 py-2">
          <a href="/blog" class="block text-sm font-medium uppercase tracking-[0.2em] transition-colors hover:text-[var(--color-primary-light)] dark:hover:text-[var(--color-primary-dark)]" data-astro-prefetch
            >Blog</a
          >

          <a href="/about" class="block text-sm font-medium uppercase tracking-[0.2em] transition-colors hover:text-[var(--color-primary-light)] dark:hover:text-[var(--color-primary-dark)]" data-astro-prefetch
            >About</a
          >

        </div>
      </div>
    </nav>

    <div class="mx-auto max-w-6xl px-4 pt-24 pb-16 sm:px-6 lg:px-8">
      <slot />
    </div>

    <footer class="border-t border-[var(--color-border-light)]/70 bg-[var(--color-surface-light)]/70 py-12 text-[var(--color-muted-light)] dark:border-[var(--color-border-dark)] dark:bg-[rgba(19,26,42,0.8)] dark:text-[var(--color-muted-dark)]">
      <div class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8">
        <div class="grid gap-10 text-sm sm:grid-cols-2 lg:grid-cols-3">
          <div>
            <p class="mb-3 text-base font-semibold text-[var(--color-text-light)] dark:text-[var(--color-text-dark)]">Soumyo Dey</p>
            <p>Tech, AI & data products, and the stories picked up along the way.</p>
          </div>
          <div class="space-y-2">
            <p class="text-xs font-semibold uppercase tracking-[0.3em] text-[var(--color-muted-light)] dark:text-[var(--color-muted-dark)]">Navigate</p>
            <div class="flex flex-wrap gap-3">
              <a class="transition-colors hover:text-[var(--color-primary-light)] dark:hover:text-[var(--color-primary-dark)]" href="/blog">Blog</a>

              <a class="transition-colors hover:text-[var(--color-primary-light)] dark:hover:text-[var(--color-primary-dark)]" href="/about">About</a>

            </div>
          </div>
          <div class="space-y-2">
            <p class="text-xs font-semibold uppercase tracking-[0.3em] text-[var(--color-muted-light)] dark:text-[var(--color-muted-dark)]">Elsewhere</p>
            <p>Email: <a class="underline decoration-dashed underline-offset-4 hover:text-[var(--color-primary-light)] dark:hover:text-[var(--color-primary-dark)]" href="mailto:heysoumyo@gmail.com">heysoumyo@gmail.com</a></p>
          </div>
        </div>
        <p class="mt-10 text-center text-xs uppercase tracking-[0.3em]">© {new Date().getFullYear()} Soumyo Dey · Crafted with coffee & code.</p>
      </div>
    </footer>

    <script>
      // Simple mobile menu toggle
      function setupMobileMenu() {
        const menuToggle = document.getElementById('menu-toggle');
        const mobileMenu = document.getElementById('mobile-menu');

        if (menuToggle && mobileMenu) {
          // Remove old listener if it exists to prevent duplicates (though Astro swaps body, so usually fine)
          const newToggle = menuToggle.cloneNode(true);
          if (menuToggle.parentNode) {
            menuToggle.parentNode.replaceChild(newToggle, menuToggle);
          }
          
          newToggle.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
          });
        }
      }
      
      // Initial load
      setupMobileMenu();
      
      // View Transitions load
      document.addEventListener('astro:page-load', setupMobileMenu);
    </script>
    <!-- Theme boot is inlined above; external preload removed -->
    <script>
      // Interactive toggle logic
      function setupThemeToggle() {
        const themeToggle = document.getElementById('theme-toggle');
        
        if (themeToggle) {
          // Clone to remove old listeners in case of re-execution
          const newToggle = themeToggle.cloneNode(true);
          themeToggle.parentNode?.replaceChild(newToggle, themeToggle);

          newToggle.addEventListener('click', () => {
            const element = document.documentElement;
            element.classList.toggle('dark');

            const isDark = element.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
          });
        }
      }

      // Initial load
      setupThemeToggle();

      // Re-run on view transition
      document.addEventListener('astro:page-load', setupThemeToggle);
    </script>
    <script>
      // Scroll Reveal Logic
      function setupScrollReveal() {
        const observerOptions = {
          root: null,
          rootMargin: '0px',
          threshold: 0.1
        };

        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.classList.add('reveal-visible');
              observer.unobserve(entry.target); // Only animate once
            }
          });
        }, observerOptions);

        document.querySelectorAll('.reveal').forEach(el => {
          observer.observe(el);
        });
      }

      // Initial load
      setupScrollReveal();

      // View Transitions load
      document.addEventListener('astro:page-load', setupScrollReveal);
    </script>
  </body>
</html>

<style is:global>
  :root {
    color-scheme: light dark;
  }

  html {
    font-family: system-ui, sans-serif;
    scroll-behavior: smooth;
  }

  @media (prefers-reduced-motion: reduce) {
    html {
      scroll-behavior: auto;
    }
  }
</style>
